<p>I've seen an interesting static site use case come up a few times recently where someone wants to use a static generator <em>along</em> with an existing dynamic site. The idea is that they would generate certain resources statically at build-time of the dynamic site and then only rely on the dynamic runtime for pages that really need it. I've long suspected that Wyam would be great in this role, particularly for ASP.NET MVC sites given that it can read the same Razor layout files. I finally got motivated enough to give this a try and will detail how to do it in this blog post. It turns out it's not hard at all and works really well once you've gotten everything set up.</p>
<p>For the purpose of this post, we'll be modifying a stock ASP.NET MVC web site. Note that there are probably a dozen different ways you could accomplish this type of integration and what I'm describing here is just one of them. Since Wyam is essentially just a console application, any process by which you run Wyam before running the ASP.NET compiler should work. For example, you could use <a href="http://cakebuild.net/">Cake</a> to build your ASP.NET MVC site and instead of running Wyam as a pre-build event as described below, you'd run it via the <a href="http://cakebuild.net/addins/category/static%20site%20generation">Wyam Cake addin</a>.</p>
<h1 id="install-wyam-into-the-site">Install Wyam Into The Site</h1>
<p>The first step is to get Wyam onto your system. Since we're already talking about a .NET project, let's go ahead and pull down the <a href="https://www.nuget.org/packages/Wyam">Wyam tools package</a> from NuGet. It's just called &quot;Wyam&quot; and can be installed via the NuGet management UI or the Package Management Console. Note that the package is currently prerelease so you might have to turn on prerelease package searching in the NuGet UI to see it.</p>
<p>Since the package is a tools package, it'll unpack the Wyam CLI executable in the <code>tools</code> subfolder where NuGet installed the package. Generally, this will be something like <code>packages/Wyam.0.13.5-beta/tools</code> (from the root of your solution).</p>
<h1 id="add-a-pre-build-event">Add a Pre-Build Event</h1>
<p>The next step is to add a pre-build event that runs Wyam every time the site is built. This is the glue that generates your static resources for inclusion by the ASP.NET compiler. Open up the project properties, go to the &quot;Build Events&quot; tab, and add the following pre-build event:</p>
<pre><code>&quot;$(SolutionDir)\packages\Wyam.0.13.5-beta\tools\wyam.exe&quot; &quot;$(SolutionDir)\config.wyam&quot;
</code></pre>
<p>Make sure to match the Wyam package folder name to the version you actually pulled down. Note that this will also need to be updated if you update the package.</p>
<p>Note that you can also run this same command directly from your command line to test the Wyam generation. That will let you iterate a bit faster and give you a bit more visibility while you're setting everything up and troubleshooting over just running Wyam during the ASP.NET site build.</p>
<h1 id="add-the-config-file">Add The Config File</h1>
<p>Note that the build event above calls the Wyam executable and tells it to use the <code>config.wyam</code> configuration file found at the root of the Solution. Let's go ahead and create that file since the build event will look for it. It should look something like this:</p>
<pre><code>#n -p Wyam.Markdown
#n -p Wyam.Yaml
#n -p Wyam.Razor

FileSystem.InputPaths.Add(&quot;ProjectName/Posts&quot;);
FileSystem.OutputPath = &quot;ProjectName/Blog&quot;;

Pipelines.Add(&quot;Posts&quot;,
	// Read all Markdown files under the &quot;Posts&quot; directory
	ReadFiles(&quot;*.md&quot;),
	// Load any frontmatter and parse it as YAML markup
	FrontMatter(Yaml()),
	// Render the Markdown content
	Markdown(),
	// Compile and render the page layout template
	Razor(),
	// Write the files as HTML
	WriteFiles(&quot;.html&quot;),
	// Order the files by publish date
	OrderBy(&#64;doc.Get&lt;DateTime&gt;(&quot;Published&quot;)).Descending()
);

Pipelines.Add(&quot;Index&quot;,
	// Read all non-layout Razor files under the &quot;Posts&quot; directory
	ReadFiles(&quot;**/{!_,}*.cshtml&quot;),
	// Evaluate the Razor page(s)
	Razor(),
	// Write the file(s) as HTML
	WriteFiles(&quot;.html&quot;)
);
</code></pre>
<p>You can add it as a Solution item if you'd like to be able to edit it from Visual Studio, otherwise you can just edit it with a text editor. The pipeline in the example above will check for all Markdown files, process any YAML frontmatter they have, render them with the existing Razor layout files (more on this below), output them as static HTML files, and then order them by post date. A second pipeline will render Razor files (for example, the list the posts). Generally, any sort of Wyam configuration file you would normally use can also be used here.</p>
<p>The main thing to notice about the configuration file is that we're setting custom input and output folders. This lets us put the input Markdown files (and associated layouts for the static pages) right in our ASP.NET project in the <code>Posts</code> folder and will generate the static HTML files for inclusion in our site in the <code>Blog</code> folder.</p>
<h1 id="a-note-about-razor-layouts">A Note About Razor Layouts</h1>
<p>One of the compelling reasons to generate static resources with Wyam inside your ASP.NET MVC site is that Wyam can make use of your existing Razor layout files...with some caveats. Mainly, you can't have any dynamic code in your layout. For example, things like the HTTP request context simply aren't available when generating pages statically. Also note that while the underlying Razor parser is very similar, Wyam Razor pages aren't <em>quite</em> the same as those in ASP.NET MVC. For example, many of the HTML helpers you might be used to aren't available. You may need to par down your top-level Razor layout to get it to work with Wyam.</p>
<p>If you do want your layout to have some dynamic code, one approach is to create a very simple outer layout and then two different inner layouts. One of the inner layouts can contain the dynamic code, HTML helpers, etc. that you have when compiling with ASP.NET MVC and should be used for your dynamic pages (probably specified by the ASP.NET MVC <code>_ViewStart.cshtml</code> file in your <code>Views</code> folder). The other inner layout can be used by your static pages and should go in the <code>Posts</code> folder that Wyam uses as input.</p>
<h1 id="input-files">Input Files</h1>
<p>I mentioned above that we'll pull the Markdown files from the <code>Posts</code> folder. Let's go ahead and make one that looks like this:</p>
<pre><code>Title: First Post
Published: 8/10/2016
---
This is my first post!
</code></pre>
<p>Then go ahead and create a couple more. At build-time, these will get read and processed by Wyam and the resulting HTML files will be placed in the <code>Blog</code> folder.</p>
<p>You can also add the <code>_ViewStart.cshtml</code> and <code>_Layout.cshtml</code> for your static pages in this folder.</p>
<p>Note that any files in your <code>Posts</code> static input folder should have a Build Action of None if you include the file in your project. Also note that the static input files don't <em>have</em> to be included in your project, Wyam will pick them up either way.</p>
<h1 id="output-files">Output Files</h1>
<p>When Wyam is run, it will place the final static results in the <code>Blog</code> folder. To make sure these files get included in your ASP.NET MVC build, you'll need to add the following to your <code>.csproj</code> file for the project (unfortunatly, opening the <code>.csproj</code> file is the only way to add a wildcard pattern like this right now):</p>
<pre><code>&lt;Content Include=&quot;Blog\**\*.*&quot; /&gt;
</code></pre>
<p>This will ensure that each build includes all of the output files from Wyam every time.</p>
<h1 id="putting-it-together">Putting It Together</h1>
<p>So let's recap:</p>
<ul>
<li>Install the Wyam tools NuGet package</li>
<li>Add a pre-build event</li>
<li>Make sure Razor layouts will work</li>
<li>Add your Markdown files</li>
<li>Add a wildcard content item to the project</li>
</ul>
<p>When you're done, you should have something that looks kind of like this:</p>
<img src="/posts/images/wyam-aspnet.png" alt="ASP.NET With Wyam" class="img-responsive" style="margin-top: 6px; margin-bottom: 6px;">
<p>You can see all of this in action in the complete example at <a href="https://github.com/Wyamio/Wyam/tree/develop/examples/AspNetMvc">https://github.com/Wyamio/Wyam/tree/develop/examples/AspNetMvc</a>.</p>
<p>If you have any questions, just let me know in the comments below.</p>
